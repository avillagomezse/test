<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Organigrama - Unificación de Procedimientos</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: Arial, sans-serif;
    }
    .node rect {
      fill: #2DAAE1;
      rx: 10;
      ry: 10;
      stroke: #1E6F9F;
      stroke-width: 1.5px;
    }
    .node text {
      fill: white;
      font-size: 12px;
      text-anchor: middle;
      alignment-baseline: middle;
    }
    .link {
      fill: none;
      stroke: #2DAAE1;
      stroke-width: 1.5px;
    }
  </style>
</head>
<body>
  <svg width="900" height="600"></svg>
  <script>
    const data = {
      name: "Unificación de procedimientos",
      children: [
        {
          name: "CD-P-001 Recepción,\nAlmacenaje y Devolución\nde Mercadería Regulada",
          children: [
            { name: "CD-P-004 Recepción y Almacenamiento" },
            { name: "CD-P-23 Recepción y Almacenaje de Mercadería" }
          ]
        },
        {
          name: "CD-P-002 Planificación\ny picking de mercadería",
          children: [
            { name: "CD-P-005 Planning" },
            { name: "CD-P-006 Picking y reposición" },
            { name: "CD-P-23 Recepción y Almacenaje de Mercadería" }
          ]
        },
        {
          name: "CD-P-003 Despacho de mercadería\ny embalaje",
          children: [
            { name: "CD-P-23 Recepción y Almacenaje de Mercadería" }
          ]
        },
        {
          name: "CD-P-021 Logística Inversa\no Devoluciones",
          children: [
            { name: "CD-P-26 Logística Inversa o Devoluciones" }
          ]
        }
      ]
    };

    const svg = d3.select("svg"),
          width = +svg.attr("width"),
          height = +svg.attr("height");

    const root = d3.hierarchy(data);
    const treeLayout = d3.tree().size([height - 40, width - 200]);
    treeLayout(root);

    // Draw links
    svg.selectAll('.link')
      .data(root.links())
      .enter()
      .append('path')
      .attr('class', 'link')
      .attr('d', d3.linkHorizontal()
        .x(d => d.y + 100)
        .y(d => d.x + 20));

    // Draw nodes
    const node = svg.selectAll('.node')
      .data(root.descendants())
      .enter()
      .append('g')
      .attr('class', 'node')
      .attr('transform', d => `translate(${d.y + 100},${d.x + 20})`);

    node.append('rect')
      .attr('width', 200)
      .attr('height', 50)
      .attr('x', -100)
      .attr('y', -25);

    node.append('text')
      .text(d => d.data.name)
      .attr('dy', 0)
      .call(wrap, 180);

    // Text wrapping function
    function wrap(text, width) {
      text.each(function() {
        const text = d3.select(this),
              words = text.text().split(/\s+/).reverse(),
              lineHeight = 1.1, 
              y = text.attr("y"),
              dy = parseFloat(text.attr("dy")),
              tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
        let line = [],
            lineNumber = 0,
            word;

        while (word = words.pop()) {
          line.push(word);
          tspan.text(line.join(" "));
          if (tspan.node().getComputedTextLength() > width) {
            line.pop();
            tspan.text(line.join(" "));
            line = [word];
            tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
          }
        }
      });
    }
  </script>
</body>
</html>
